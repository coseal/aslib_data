# Author: Haniye Kashgarani
# Affiliation: University of Wyoming
# Date: 2023-08-17T15:39:37+00:00
# Github: haniyeka

name: aslib_data_check

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

jobs:
  ASLIB_data_check_tool:
    runs-on: ubuntu-latest
    #container:
      # Docker image that includes python2.7, and libraries like liac-arff, pyyaml, and typing
      # This docker also includes files from https://github.com/coseal/aslib-spec/tree/master/data_check_tool_python in /usr/src/app/data_check_tool_python
      #image: haniyeka/aslib_data_check:latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        fetch-depth: 0
#    - name: Find changed directories
 #     run: 
    - name: Get changed directories
      id: get-changes
      run: |
        git diff 
        echo  ${{ github.event.before }} 
        echo "$GITHUB_CONTEXT"| jq '.event.commits[].id' | tail -2 | head -1 |sed 's/\"//g'
        echo ${{ github.sha }}
        dirs=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }} | \
             grep '/.*$' | \
             sed -E 's@(.*)/@\1@' | \
             sort -u | \
             tr '\n' ' ')
        echo "Changed directories: $dirs"
        echo "DIRS=$dirs" >> $GITHUB_ENV

    #- name: Find directories containing description.txt
    #  run: |
     #   dirs=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep '/.*$' | sed -E 's@(.*)/@\1@' | sort -u | tr '\n' ' ')
      #  #dirs=$(find . -type f -name 'description.txt' -exec dirname {} \; | tr '\n' ' ')
       # echo $dirs
        #echo "DIRS=${dirs}" >> $GITHUB_ENV
      #shell: bash
    
      #echo "DIRS=$(find . -type f -name 'description.txt' -exec dirname {} \;)" >> $GITHUB_ENV
      #run: echo "DIRS=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep '/.*$' | sed -E 's@(.*)/@\1@' | sort -u | tr '\n' ' ')" >> $GITHUB_ENV

    - name: Run script on changed directories
      run: |
        echo "Current directory:"
        echo $(pwd)
        ls /usr/src/app/data_check_tool_python/src/
        echo $DIRS

        for dir in $DIRS; do
          if [ -d "$dir" ]; then
            python /usr/src/app/data_check_tool_python/src/main.py --dir "$dir"
          fi
        done
